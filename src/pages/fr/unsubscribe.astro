---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { useTranslations } from '@/i18n';

const lang = 'fr';
const t = useTranslations(lang);

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
---

<BaseLayout title={t('unsubscribe.title')} lang={lang}>
  <div class="container py-8">
    <div class="max-w-md mx-auto">
      <Card>
        <CardHeader>
          <CardTitle>{t('unsubscribe.title')}</CardTitle>
        </CardHeader>
        <CardContent>
          <div id="unsubscribe-status">
            <p class="text-muted-foreground">{t('unsubscribe.processing')}</p>
          </div>
        </CardContent>
      </Card>
    </div>
  </div>

  <script is:inline define:vars={{ supabaseUrl, translations: { success: t('unsubscribe.success'), error: t('unsubscribe.error'), noToken: t('unsubscribe.noToken') } }}>
    (async function() {
      const statusEl = document.getElementById('unsubscribe-status');
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');

      function showMessage(message, isError) {
        statusEl.textContent = '';
        const div = document.createElement('div');
        div.className = isError
          ? 'rounded-lg border border-destructive/50 text-destructive p-4'
          : 'rounded-lg border border-green-500/50 text-green-700 dark:text-green-400 p-4';
        div.textContent = message;
        statusEl.appendChild(div);
      }

      if (!token) {
        showMessage(translations.noToken, true);
        return;
      }

      try {
        const response = await fetch(`${supabaseUrl}/functions/v1/unsubscribe?token=${token}`);
        const data = await response.json();

        if (response.ok && data.success) {
          showMessage(translations.success, false);
        } else {
          showMessage(translations.error, true);
        }
      } catch (error) {
        showMessage(translations.error, true);
      }
    })();
  </script>
</BaseLayout>
